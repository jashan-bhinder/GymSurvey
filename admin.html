<!DOCTYPE html>
<html>
    <head>
        <meta charset = "utf-8"/>
        <title>Gym Survey - Admin</title>
        <link rel="stylesheet" href="./styles.css" />
    </head>
    <body>
        <h1>Admin: Responses</h1>

        <button id = "clear">Clear all responses</button>
        <button id = "export">Export CSV</button>


        <p id = "summary">Loading...</p>
        <ol id = "list"></ol>

        <hr class="divider" />
        <p><a href="./index.html">Back to survey</a></p>


        <script>
            const STORAGE_KEY = 'gymsurvey:responses'
            const summary = document.getElementById('summary');
            const list = document.getElementById('list');

            function loadResponses(){
                const raw = localStorage.getItem(STORAGE_KEY);
                try {
                    return raw ? JSON.parse(raw) : [];
                }
                catch{
                    return[];
                }
            }

            function saveResponses(responses){
                localStorage.setItem(STORAGE_KEY, JSON.stringify(responses));
            }

            function toCSV (rows) {
                const header = ['value', 'at'];
                const lines = [header.join(',')];

                for (const r of rows) {
                    const v = String(r.value);
                    const a = String(r.at);
                    lines.push([v, a].join(',')); 
                }
                return lines.join('\n')
            }

            function download(filename, text) {
                const blob = new Blob([text], { type: 'text/csv;charset=utf-8;' }) 
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            
            }
            document.getElementById('export').addEventListener('click', () => {
                if (!responses.length){
                    alert('No responses to export,');
                    return;
                }
                const csv = toCSV(responses);
                download('responses.csv', csv)
            })


            document.getElementById('clear').addEventListener('click', () =>{

                const ok = confirm('Delete ALL saved responses? This cannot be undone. ')
                if (!ok) return;

                saveResponses([]);
                summary.textContent = 'No responses yet.';

                while (list.firstChild) list.removeChild(list.firstChild);
            });
            const responses = loadResponses();

            if (!responses.length) {
                summary.textContent = 'No responses yet.';
                list.innerHTML = '';
            }
            else {
                summary.textContent = `Total: responses: ${responses.length}`;

                list.innerHTML = '';
                for (const item of responses) {
                    const li = document.createElement('li');
                    const when = new Date(item.at).toLocaleString();
                    li.textContent = `Value: ${item.value} - at ${when}`;
                    list.appendChild(li);
                }
            }
        </script>
    </body>
</html>